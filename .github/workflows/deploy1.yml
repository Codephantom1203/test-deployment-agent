name: Deploy to AWS S3 Static Website

on:
  push:
    branches: [ main ]

env:
  BUCKET_NAME: my-static-site-${{ github.run_number }}-${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create dist directory
      run: mkdir -p dist
    
    - name: Generate static HTML
      run: |
        echo '<!DOCTYPE html>' > dist/index.html
        echo '<html lang="en">' >> dist/index.html
        echo '<head>' >> dist/index.html
        echo '    <meta charset="UTF-8">' >> dist/index.html
        echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> dist/index.html
        echo '    <title>My Static Site</title>' >> dist/index.html
        echo '</head>' >> dist/index.html
        echo '<body>' >> dist/index.html
        echo '    <h1>Welcome to My Static Website</h1>' >> dist/index.html
        echo '    <p>This site was deployed using GitHub Actions to AWS S3.</p>' >> dist/index.html
        echo '    <p>Build Number: ${{ github.run_number }}</p>' >> dist/index.html
        echo '    <p>Commit SHA: ${{ github.sha }}</p>' >> dist/index.html
        echo '</body>' >> dist/index.html
        echo '</html>' >> dist/index.html
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: static-site
        path: dist/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: static-site
        path: dist/
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Create S3 bucket
      run: |
        aws s3 mb s3://$BUCKET_NAME --region us-east-1 || echo "Bucket may already exist"
    
    - name: Enable static website hosting
      run: |
        aws s3 website s3://$BUCKET_NAME --index-document index.html --error-document index.html
    
    - name: Create bucket policy
      run: |
        echo '{' > bucket-policy.json
        echo '  "Version": "2012-10-17",' >> bucket-policy.json
        echo '  "Statement": [' >> bucket-policy.json
        echo '    {' >> bucket-policy.json
        echo '      "Sid": "PublicReadGetObject",' >> bucket-policy.json
        echo '      "Effect": "Allow",' >> bucket-policy.json
        echo '      "Principal": "*",' >> bucket-policy.json
        echo '      "Action": "s3:GetObject",' >> bucket-policy.json
        echo '      "Resource": "arn:aws:s3:::'"$BUCKET_NAME"'/*"' >> bucket-policy.json
        echo '    }' >> bucket-policy.json
        echo '  ]' >> bucket-policy.json
        echo '}' >> bucket-policy.json
    
    - name: Apply bucket policy
      run: |
        aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json
    
    - name: Upload files to S3
      run: |
        aws s3 cp dist/index.html s3://$BUCKET_NAME/index.html --content-type "text/html"
    
    - name: Output